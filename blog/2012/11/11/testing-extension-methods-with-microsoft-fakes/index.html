<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Testing extension methods with Microsoft Fakes</title>
  <meta name="description" content="With right dosage of proper design, decoupling objects, dependency injection and simplicity, you can write testable code without requiring sophisticated tools.">
  
  <meta name="keywords" content=""/>
  
  <meta content="StackToHeap" property="og:site_name">

  <meta content="Testing extension methods with Microsoft Fakes" property="og:title">


  <meta content="article" property="og:type">


  <meta content="With right dosage of proper design, decoupling objects, dependency injection and simplicity, you can write testable code without requiring sophisticated tools." property="og:description">


  <meta content="https://stacktoheap.com/blog/2012/11/11/testing-extension-methods-with-microsoft-fakes/" property="og:url">


  <meta content="2012-11-11T21:55:00+00:00" property="article:published_time">
  <meta content="https://stacktoheap.com/about/" property="article:author">


  <meta content="https://stacktoheap.com/images/logo-high-resolution.png" property="og:image">


  
  <meta content="unit testing" property="article:section">
  


  


  <meta name="twitter:site" value="@manojlds">
<meta name="twitter:creator" value="@manojlds">
<meta name="twitter:card" value="summary_large_image">

<meta name="twitter:image" content="https://stacktoheap.com/images/logo-high-resolution.png">



  <meta name="theme-color" content="#641AE6">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="preload" href="/assets/css/syntax.css" as="style" onload="this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/css/syntax.css"></noscript>
  <link rel="canonical" href="https://stacktoheap.com/blog/2012/11/11/testing-extension-methods-with-microsoft-fakes/">
  <link rel="alternate" type="application/rss+xml" title="StackToHeap" href="https://stacktoheap.com/feed.xml">
  <link rel="manifest" href="/manifest.json">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35693303-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


  <body class="font-sans m-0">

    <div class="navbar bg-primary text-primary-content">
  <div class="flex-1">
    <a class="btn btn-ghost normal-case text-xl" href="/" >
      StackToHeap
    </a>
  </div>
  <div class="flex-none">
    <ul class="menu menu-horizontal px-1">
      
        
        <li><a href="/about/">About</a></li>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
      <li><a href="/feed.xml">RSS</a></li>
    </ul>
  </div>
</div>

    <div class="container mt-12">
        <article class="prose lg:prose-xl lg:leading-normal" itemscope itemtype="http://schema.org/BlogPosting">
  <h1 itemprop="name headline">Testing extension methods with Microsoft Fakes</h1>
  <p class="post-meta"><time datetime="2012-11-11T21:55:00+00:00" itemprop="datePublished">Nov 11, 2012</time></p>
  <div class="post-content" itemprop="articleBody">
    <p>Testing static methods, or to be more specific, extensions methods is imposssible with the standard mocking frameworks like Moq ( which I prefer ) and RhinoMocks. There do exist more sophisticated frameworks like TypeMock and JustMock which can do the job for you. I have been pretty contended with the simplicity of Moq. Also, when you want to mock static methods or do some other magic, many a times, it means that there is something wrong with the design. With right dosage of proper design, decoupling objects, dependency injection and simplicity, you can write testable code without requiring sophisticated tools.</p>

<p>I did come across <a href="http://msdn.microsoft.com/en-us/library/hh549175.aspx">Microsoft Fakes</a> that is available with Visual Studio 2012. It is built on top of ( and to replace ) Microsoft Moles that was available previously. In a project that I was writing, the simplest design was in using extension methods ( which, in C#, are effectively static methods). Testing them posed a problem. This was a good time as any to try out Microsoft Fakes.</p>

<p><img src="https://stacktoheap.com/images/fakes.PNG" alt="MicrosoftFakes" /></p>

<p>Starting with the framework was pretty simple. Add the fake assembly for the assembly to be “shimmed” in the Test Project. Using Visual Studio Ultimate ( which is required) you can just right click on the assembly reference and click on “Add Fakes assembly.” This creates and adds a reference to the fake assembly.</p>

<p>Now, we can easily add a shim that replaces the actual extension method. A standard test would look like below:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">TestFixture</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ToggledFeatureTests</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Test</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldReturnOneWhenToggledFeatureIsOn</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">toggledFeature</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ToggledFeature</span><span class="p">();</span>

        <span class="k">using</span> <span class="p">(</span><span class="n">ShimsContext</span><span class="p">.</span><span class="nf">Create</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">Fakes</span><span class="p">.</span><span class="n">ShimToggledExtensions</span><span class="p">.</span><span class="n">IsOnIToggled</span> <span class="p">=</span> <span class="n">toggled</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">toggledFeature</span><span class="p">.</span><span class="nf">SomeProcessing</span><span class="p">(),</span> <span class="n">Is</span><span class="p">.</span><span class="nf">EqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The extension method being shimmed here is</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsOn</span><span class="p">(</span><span class="k">this</span> <span class="n">IToggled</span> <span class="n">toggledFeature</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">appSettingKeyForToggledFeature</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0}.{1}"</span><span class="p">,</span> <span class="s">"Toggler"</span><span class="p">,</span> <span class="n">toggledFeature</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="n">Name</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="n">appSettingKeyForToggledFeature</span><span class="p">]</span> <span class="p">==</span> <span class="s">"true"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>The shims have to be used with a ShimsContext using block as seen in the test code above. When the context is disposed, the method intercepts are reset to normalcy.</p>

<p>The fakes generated by Fakes follow some naming conventions. Without going into the details, the original type <code class="language-plaintext highlighter-rouge">ToggledExtensions</code> is replaced with <code class="language-plaintext highlighter-rouge">Fakes.ShimToggleExtensions</code> and the <code class="language-plaintext highlighter-rouge">IsOn</code> method in it which takes in a <code class="language-plaintext highlighter-rouge">IToggled</code> ( like a normal static method would, but in this an extension method) is called <code class="language-plaintext highlighter-rouge">IsOnIToggled</code>. The shim being provided is the lambda <code class="language-plaintext highlighter-rouge">toggled =&gt; true</code>. That is return true for any <code class="language-plaintext highlighter-rouge">IToggled</code> instance. Then there is a pretty standard assert.</p>

<p>There are some disadvantages with Microsoft Fakes. First and foremost, it might lead to bad code. In certain situations,tools like this help you to test code without having to make severe changes to it (like wrapping static method calls in a class ) or designing it in a complicated way just to support testing. But like already mentioned, most of the times, untestable code indicates something much deeper - code smells, bad design etc. You need to make a conscious decision when to use these feature of Microsoft Fakes. Secondly, Fakes requires Visual Studio Ultimate. Last, when using shims, the tests fail when running from Resharper ( 7.0 ) provided runner. This is a huge deal as my entire team uses Resharper and the tests must pass with the runner. There is a <a href="http://youtrack.jetbrains.com/issue/RSRP-328377">bug filed with JetBrains</a> and I am hoping it will be fixed soon. If you use the Nunit Test adpater and the VS 2012 Test runner, the tests pass, however.</p>

<p>I haven’t used the stub facilities provided by Microsoft Fakes and I am not sure it will be needed, considering that Moq should suffice. Shims, however, I see myself using in certain circumstances, especially once the Resharper bug is fixed.</p>

  </div>
  
    <div class="divider">Comments</div>
    <section>
      <div id="disqus_thread" aria-live="polite">
<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
      this.page.url = 'https://stacktoheap.com/blog/2012/11/11/testing-extension-methods-with-microsoft-fakes/';
      this.page.identifier = 'https://stacktoheap.com/blog/2012/11/11/testing-extension-methods-with-microsoft-fakes/';
    };
    
    (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://stacktoheap.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
  
</article>

    </div>

    <footer class="footer footer-center p-10 bg-base-200 text-base-content rounded">
  <div class="grid grid-flow-col gap-4">
  </div> 
  <div>
    <div class="grid grid-flow-col gap-4">
      <a href="https://github.com/manojlds"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path></svg></a> 
      <a href="https://github.com/manojlds"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="inline-block h-5 w-5 fill-current md:h-6 md:w-6"><path d="M256,32C132.3,32,32,134.9,32,261.7c0,101.5,64.2,187.5,153.2,217.9a17.56,17.56,0,0,0,3.8.4c8.3,0,11.5-6.1,11.5-11.4,0-5.5-.2-19.9-.3-39.1a102.4,102.4,0,0,1-22.6,2.7c-43.1,0-52.9-33.5-52.9-33.5-10.2-26.5-24.9-33.6-24.9-33.6-19.5-13.7-.1-14.1,1.4-14.1h.1c22.5,2,34.3,23.8,34.3,23.8,11.2,19.6,26.2,25.1,39.6,25.1a63,63,0,0,0,25.6-6c2-14.8,7.8-24.9,14.2-30.7-49.7-5.8-102-25.5-102-113.5,0-25.1,8.7-45.6,23-61.6-2.3-5.8-10-29.2,2.2-60.8a18.64,18.64,0,0,1,5-.5c8.1,0,26.4,3.1,56.6,24.1a208.21,208.21,0,0,1,112.2,0c30.2-21,48.5-24.1,56.6-24.1a18.64,18.64,0,0,1,5,.5c12.2,31.6,4.5,55,2.2,60.8,14.3,16.1,23,36.6,23,61.6,0,88.2-52.4,107.6-102.3,113.3,8,7.1,15.2,21.1,15.2,42.5,0,30.7-.3,55.5-.3,63,0,5.4,3.1,11.5,11.4,11.5a19.35,19.35,0,0,0,4-.4C415.9,449.2,480,363.1,480,261.7,480,134.9,379.7,32,256,32Z"></path></svg></a> 
    </div>
  </div> 
  <div>
    <p>Copyright © 2023 - StackToHeap</p>
  </div>
</footer>

    <script type="text/javascript">
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

  </body>

</html>
