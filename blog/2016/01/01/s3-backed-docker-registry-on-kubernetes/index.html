<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Hosting an S3 backed Docker Registry on Kubernetes</title>
  <meta name="description" content="Hosting an S3 backed Docker Registry on Kubernetes">
  
  <meta name="keywords" content="docker, kubernetes, docker-registry, S3"/>
  
  <meta content="StackToHeap" property="og:site_name">

  <meta content="Hosting an S3 backed Docker Registry on Kubernetes" property="og:title">


  <meta content="article" property="og:type">


  <meta content="Hosting an S3 backed Docker Registry on Kubernetes" property="og:description">


  <meta content="http://localhost:4000/blog/2016/01/01/s3-backed-docker-registry-on-kubernetes/" property="og:url">


  <meta content="2016-01-01T23:20:00+00:00" property="article:published_time">
  <meta content="http://localhost:4000/about/" property="article:author">


  <meta content="http://localhost:4000/images/logo-high-resolution.png" property="og:image">


  
  <meta content="docker" property="article:section">
  


  
  <meta content="docker" property="article:tag">
  
  <meta content="kubernetes" property="article:tag">
  
  <meta content="docker-registry" property="article:tag">
  
  <meta content="S3" property="article:tag">
  


  <meta name="twitter:site" value="@manojlds">
<meta name="twitter:creator" value="@manojlds">
<meta name="twitter:card" value="summary_large_image">

<meta name="twitter:image" content="http://localhost:4000/images/logo-high-resolution.png">


  <meta name="twitter:label1" value="Reading time">
  <meta name="twitter:data1" value="6 mins ðŸ•‘">


  <meta name="theme-color" content="#641AE6">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="preload" href="/assets/css/syntax.css" as="style" onload="this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/css/syntax.css"></noscript>
  <link rel="canonical" href="http://localhost:4000/blog/2016/01/01/s3-backed-docker-registry-on-kubernetes/">
  <link rel="alternate" type="application/rss+xml" title="StackToHeap" href="http://localhost:4000/feed.xml">
  <link rel="manifest" href="/manifest.json">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35693303-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


  <body class="font-sans m-0">

    <div class="navbar bg-primary text-primary-content">
  <div class="flex-1">
    <a class="btn btn-ghost normal-case text-xl" href="/" >
      StackToHeap
    </a>
  </div>
  <div class="flex-none">
    <ul class="menu menu-horizontal px-1">
      
        
        <li><a href="/about/">About</a></li>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
      <li><a href="/feed.xml">RSS</a></li>
    </ul>
  </div>
</div>

    <div class="container mt-12">
        <article class="prose lg:prose-xl lg:leading-normal" itemscope itemtype="http://schema.org/BlogPosting">
  <h1 itemprop="name headline">Hosting an S3 backed Docker Registry on Kubernetes</h1>
  <p class="post-meta"><time datetime="2016-01-01T23:20:00+00:00" itemprop="datePublished">Jan 1, 2016</time></p>
  <div class="post-content" itemprop="articleBody">
    <p>Running a docker registry (v2) on Kubernetes is <a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/registry">well documented as an addon to Kubernetes</a>.</p>

<p>That setup, however, involves proxying the registry as <code class="language-plaintext highlighter-rouge">localhost</code> on each Kubernetes node. While this simplifies pulling on nodes (no insecure registry issue, as it is localhost), this makes building and pushing outside the Kubernetes cluster unnecessarily complex and hacky  (you need to <code class="language-plaintext highlighter-rouge">kubectl port-forward</code> to access the registry, and you also must build your images with the tag like <code class="language-plaintext highlighter-rouge">localhost:5000/repository/image:version</code>.) Moreover, it is based on Persistent Volume storage.</p>

<p>For a better docker registry setup, we wanted two things:</p>

<ul>
  <li>S3 backed registry so that storage is managed better.</li>
  <li>Proper service for registry so that push and pull are more sane, and image tags are proper. We would like to push and pull from local workstation and our CI boxes. Also, at any time we can move to a different hosting solution for our private registry without have to retag and push images.</li>
</ul>

<p>For S3 storage, we can utilize the ability to override all the configuration for the registry via environment variables. Our <code class="language-plaintext highlighter-rouge">ReplicationController</code> looks like the following:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ReplicationController</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-registry-v0</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-registry</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v0</span>
    <span class="s">kubernetes.io/cluster-service</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-registry</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v0</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-registry</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v0</span>
        <span class="s">kubernetes.io/cluster-service</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">registry</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">registry:2.2.1</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_HTTP_ADDR</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">:5000</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">S3</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_ACCESSKEY</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;access_key&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_SECRETKEY</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;secret_key&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_REGION</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">us-east-1</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_BUCKET</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;S3_bucket&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_ENCRYPT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_SECURE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_V4AUTH</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_STORAGE_S3_CHUNKSIZE</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">5242880"</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">REGISTRY_HTTP_SECRET</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;secret&gt;"</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">5000</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">registry</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span></code></pre></figure>

<p>It is important to set <code class="language-plaintext highlighter-rouge">REGISTRY_STORAGE</code> to <code class="language-plaintext highlighter-rouge">S3</code> so that the default storage configuration is overridden. If this is not done, you will get an error regarding multiple storage drivers. <code class="language-plaintext highlighter-rouge">REGISTRY_HTTP_SECRET</code> has been added so that load balancing across multiple pods will work, when needed. Rest of the settings are pretty standard for a S3 backed registry, <a href="https://github.com/docker/distribution/blob/master/docs/configuration.md#storage">as per the docs</a>.</p>

<p>We have a service that looks like below (For context, our Kubernetes cluster is on AWS, and has AWS aware features enabled):</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-registry</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-registry</span>
    <span class="s">kubernetes.io/cluster-service</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="s">kubernetes.io/name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">KubeRegistry"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-registry</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">registry</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">5000</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span></code></pre></figure>

<p>We have a nice Route53 alias for the resulting ELB so that we can push and pull like we would to any other private registry. With the DNS name and S3 storage, moving away from Kubernetes for the registry is trivial too.</p>

<p>Improvements: Obviously, we are running an insecure registry at the moment. Thatâ€™s something on our TODO list of things to fix. Currently, our CoreOS nodes, local workstations and CI boxes have Docker service running with the <code class="language-plaintext highlighter-rouge">--insecure-registry</code> flag.</p>

  </div>
  
    <div class="divider">Comments</div>
    <section>
      <div id="disqus_thread" aria-live="polite">
<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/blog/2016/01/01/s3-backed-docker-registry-on-kubernetes/';
      this.page.identifier = 'http://localhost:4000/blog/2016/01/01/s3-backed-docker-registry-on-kubernetes/';
    };
    
    (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://stacktoheap.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
  
</article>

    </div>

    <footer class="footer footer-center p-10 bg-base-200 text-base-content rounded">
  <div class="grid grid-flow-col gap-4">
  </div> 
  <div>
    <div class="grid grid-flow-col gap-4">
      <a href="https://github.com/manojlds"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path></svg></a> 
      <a href="https://github.com/manojlds"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="inline-block h-5 w-5 fill-current md:h-6 md:w-6"><path d="M256,32C132.3,32,32,134.9,32,261.7c0,101.5,64.2,187.5,153.2,217.9a17.56,17.56,0,0,0,3.8.4c8.3,0,11.5-6.1,11.5-11.4,0-5.5-.2-19.9-.3-39.1a102.4,102.4,0,0,1-22.6,2.7c-43.1,0-52.9-33.5-52.9-33.5-10.2-26.5-24.9-33.6-24.9-33.6-19.5-13.7-.1-14.1,1.4-14.1h.1c22.5,2,34.3,23.8,34.3,23.8,11.2,19.6,26.2,25.1,39.6,25.1a63,63,0,0,0,25.6-6c2-14.8,7.8-24.9,14.2-30.7-49.7-5.8-102-25.5-102-113.5,0-25.1,8.7-45.6,23-61.6-2.3-5.8-10-29.2,2.2-60.8a18.64,18.64,0,0,1,5-.5c8.1,0,26.4,3.1,56.6,24.1a208.21,208.21,0,0,1,112.2,0c30.2-21,48.5-24.1,56.6-24.1a18.64,18.64,0,0,1,5,.5c12.2,31.6,4.5,55,2.2,60.8,14.3,16.1,23,36.6,23,61.6,0,88.2-52.4,107.6-102.3,113.3,8,7.1,15.2,21.1,15.2,42.5,0,30.7-.3,55.5-.3,63,0,5.4,3.1,11.5,11.4,11.5a19.35,19.35,0,0,0,4-.4C415.9,449.2,480,363.1,480,261.7,480,134.9,379.7,32,256,32Z"></path></svg></a> 
    </div>
  </div> 
  <div>
    <p>Copyright Â© 2023 - StackToHeap</p>
  </div>
</footer>

    <script type="text/javascript">
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

  </body>

</html>
