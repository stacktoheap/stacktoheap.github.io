<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Precompiling Razor views in ASP.NET MVC 3</title>
  <meta name="description" content="A quick guide to precompiling Razor views in ASP.NET MVC 3 for improved performance.">
  
  <meta name="keywords" content=""/>
  
  <meta content="StackToHeap" property="og:site_name">

  <meta content="Precompiling Razor views in ASP.NET MVC 3" property="og:title">


  <meta content="article" property="og:type">


  <meta content="A quick guide to precompiling Razor views in ASP.NET MVC 3 for improved performance." property="og:description">


  <meta content="http://localhost:4000/blog/2013/01/19/precompiling-razor-views-in-asp-dot-net-mvc-3/" property="og:url">


  <meta content="2013-01-19T22:38:00+00:00" property="article:published_time">
  <meta content="http://localhost:4000/about/" property="article:author">


  <meta content="http://localhost:4000/images/logo-high-resolution.png" property="og:image">


  
  <meta content="mvc" property="article:section">
  


  


  <meta name="twitter:site" value="@manojlds">
<meta name="twitter:creator" value="@manojlds">
<meta name="twitter:card" value="summary_large_image">

<meta name="twitter:image" content="http://localhost:4000/images/logo-high-resolution.png">



  <meta name="theme-color" content="#641AE6">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="preload" href="/assets/css/syntax.css" as="style" onload="this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/assets/css/syntax.css"></noscript>
  <link rel="canonical" href="http://localhost:4000/blog/2013/01/19/precompiling-razor-views-in-asp-dot-net-mvc-3/">
  <link rel="alternate" type="application/rss+xml" title="StackToHeap" href="http://localhost:4000/feed.xml">
  <link rel="manifest" href="/manifest.json">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35693303-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


  <body class="font-sans m-0">

    <div class="navbar bg-primary text-primary-content">
  <div class="flex-1">
    <a class="btn btn-ghost normal-case text-xl" href="/" >
      StackToHeap
    </a>
  </div>
  <div class="flex-none">
    <ul class="menu menu-horizontal px-1">
      
        
        <li><a href="/about/">About</a></li>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
      <li><a href="/feed.xml">RSS</a></li>
    </ul>
  </div>
</div>

    <div class="container mt-12 p-4">
        <article class="prose lg:prose-xl lg:leading-normal" itemscope itemtype="http://schema.org/BlogPosting">
  <h1 itemprop="name headline">Precompiling Razor views in ASP.NET MVC 3</h1>
  <p class="post-meta"><time datetime="2013-01-19T22:38:00+00:00" itemprop="datePublished">Jan 19, 2013</time></p>
  <div class="post-content" itemprop="articleBody">
    <p>Before I start talking about how to go about precompiling razor views in ASP.NET MVC 3, let’s talk about the why.</p>

<p>The foremost reason is performance. Razor views are compiled at runtime. In projects with many views, this can be slow down the app start-up time. For better performance, it is ideal to precompile your razor views.</p>

<p>Even if performance if not a criterion and you don’t have that many views anyway, you also get the advantage of making sure that your razor views do compile at build time rather than at runtime. By default, in MVC 3, you get compile errors from the razor view only when you hit that view from your app. You get no idea, even if you have some silly typo ( though your IDE might be complaining ), till you hit the app. It is nice to have the safety net of compiling your razor views at build time.</p>

<p>Note that precompiling razor views, as will be described here, is NOT the came as compiling them. MVC 3 has the <code class="language-plaintext highlighter-rouge">MvcBuildViews</code> feature whereby, by changing the default <code class="language-plaintext highlighter-rouge">&lt;MvcBuildViews&gt;false&lt;/MvcBuildViews&gt;</code> to true in you csproj file, you can compile your razor views at compile time. But this can only be used for catching compilation errors in your views, and it’s not the same as precompilation. If you don’t want precompilation, you can live with this. It is a simple one line change in your csproj file, and you get the safety net that we talked about. Precompiling your views is slightly more complex. But, <code class="language-plaintext highlighter-rouge">MvcBuildViews</code> will slow down your build ( maybe that is the reason why it is not enabled by default!). It is just not as efficient as the precompilation technique that we are going to talk about. In our project, with lots and lots of views, the build time with precompilation was faster than the build time with <code class="language-plaintext highlighter-rouge">MvcBuildViews</code> by a whopping 50%. Thats a lot you can shave off your build times.</p>

<p>Another reason to use precompilation is that you don’t need to deploy all those <code class="language-plaintext highlighter-rouge">.cshtml</code> files to your web server. This will reduce deployment times, especially, again, for projects with many view files.</p>

<p>Hope these reasons convinced you that precompiled razor views is the best thing since sliced bread. I will talk about the specific approach that I took to achieve this. We will be using the amazing library called <code class="language-plaintext highlighter-rouge">RazorGenerator</code>.</p>

<p>Go ahead and install the Nuget packages <a href="http://nuget.org/packages/RazorGenerator.Mvc"><code class="language-plaintext highlighter-rouge">RazorGenerator.Mvc</code></a> and <a href="http://nuget.org/packages/RazorGenerator.MsBuild"><code class="language-plaintext highlighter-rouge">RazorGenerator.MsBuild</code></a> into your MVC project.</p>

<p>The <code class="language-plaintext highlighter-rouge">RazorGenerator.Mvc</code> package brings in the <code class="language-plaintext highlighter-rouge">PrecompiledMvcEngine</code> and registers it as the view engine in your mvc project. It does so in the <code class="language-plaintext highlighter-rouge">RazorGeneratorMvcStart</code> class found under <code class="language-plaintext highlighter-rouge">App_Start</code> folder:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="n">WebActivator</span><span class="p">.</span><span class="nf">PostApplicationStartMethod</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MvcApplication1</span><span class="p">.</span><span class="n">App_Start</span><span class="p">.</span><span class="n">RazorGeneratorMvcStart</span><span class="p">),</span> <span class="s">"Start"</span><span class="p">)]</span>

<span class="k">namespace</span> <span class="nn">MvcApplication1.App_Start</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">RazorGeneratorMvcStart</span> <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">engine</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PrecompiledMvcEngine</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RazorGeneratorMvcStart</span><span class="p">).</span><span class="n">Assembly</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">UsePhysicalViewsIfNewer</span> <span class="p">=</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">IsLocal</span>
            <span class="p">};</span>

            <span class="n">ViewEngines</span><span class="p">.</span><span class="n">Engines</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">engine</span><span class="p">);</span>

            <span class="c1">// StartPage lookups are done by WebPages.</span>
            <span class="n">VirtualPathFactoryManager</span><span class="p">.</span><span class="nf">RegisterVirtualPathFactory</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>It uses <code class="language-plaintext highlighter-rouge">WebActivator</code> to add the <code class="language-plaintext highlighter-rouge">PrecompiledMvcEngine</code> as a view engine in your project. Note also the line <code class="language-plaintext highlighter-rouge">UsePhysicalViewsIfNewer = HttpContext.Current.Request.IsLocal</code>. That enables you to develop with precompiled razor views as you would have done before. When you make changes to a razor file, you don’t have to compile your project ( and hence precompiling the razor views ). Just refresh the app and see the change. As is obvious from the line, if the actual <code class="language-plaintext highlighter-rouge">.cshtml</code> file are newer, it will use them for local requests, instead of the precompiled version. This means seamless transition to precompile views. Neat!</p>

<p>Now, let’s get to the exciting part - hooking up the actual precompilation of views at build time. This is where the <code class="language-plaintext highlighter-rouge">RazorGenerator.MsBuild</code> package comes into the picture. It provides msbuild targets to precompile your razor views that you can hookup into your csproj.</p>

<p>You want to import the <code class="language-plaintext highlighter-rouge">RazorGenerator.targets</code> that comes with the package in your csproj:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$(MSBuildExtensionsPath32)\Microsoft\VisualStudio\v10.0\WebApplications\Microsoft.WebApplication.targets"</span> <span class="na">Condition=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$(SolutionDir)\packages\RazorGenerator.MsBuild.1.5.0.0\tools\RazorGenerator.targets"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>The second import is the one being added, and I add it below the one importing the WebApplication related targets.</p>

<p>Next, you have to add a property that the target imported from the <code class="language-plaintext highlighter-rouge">RazorGenerator.targets</code> files uses to check if precompilation is to be done or not:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;MvcBuildViews&gt;</span>false<span class="nt">&lt;/MvcBuildViews&gt;</span>
<span class="nt">&lt;PrecompileRazorFiles&gt;</span>true<span class="nt">&lt;/PrecompileRazorFiles&gt;</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">PrecompileRazorFiles</code> is the property being added and I have added it just below <code class="language-plaintext highlighter-rouge">MvcBuildViews</code> in the csproj for obvious reasons.</p>

<p><img src="http://localhost:4000/images/razor_precompile_error.png" alt="RazorPrecompilationError" /></p>

<p>That’s it! You can now build your application and the views will be precompiled. Try introducing a compile error in one of your razor views and you should get the error when compiling your solution. The precompiled files will be generated under <code class="language-plaintext highlighter-rouge">obj\CodeGen</code>.</p>

<p>There is one more thing that you have to do if you don’t want to include the views as part of your deployment package. By default, the <code class="language-plaintext highlighter-rouge">.cshtml</code> files will be created as <code class="language-plaintext highlighter-rouge">Content</code> type. The web applications target looks for all content types and includes them in the <code class="language-plaintext highlighter-rouge">_PublishedWebsites</code> folder. So you have to change the <code class="language-plaintext highlighter-rouge">Build Action</code> for your views to <code class="language-plaintext highlighter-rouge">None</code> so that they don’t get included. This can be easily automated without changing the view properties. Just add the below to your <code class="language-plaintext highlighter-rouge">.csproj</code></p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$(SolutionDir)\packages\RazorGenerator.MsBuild.1.5.0.0\tools\RazorGenerator.targets"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">"BeforeBuild"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ItemGroup&gt;</span>
      <span class="nt">&lt;Content</span> <span class="na">Remove=</span><span class="s">"Views\**\*.cshtml"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;None</span> <span class="na">Include=</span><span class="s">"Views\**\*.cshtml"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Target&gt;</span></code></pre></figure>

<p>I am adding the <code class="language-plaintext highlighter-rouge">BeforeBuild</code> target right after the previouly added line to import the <code class="language-plaintext highlighter-rouge">RazorGenerator.targets</code> file. The <code class="language-plaintext highlighter-rouge">BeforeBuild</code> target is a hook provided to do things as a pre-build event. Here we remove all <code class="language-plaintext highlighter-rouge">.cshtml</code> from <code class="language-plaintext highlighter-rouge">Content</code> itemgroup and add them all to the <code class="language-plaintext highlighter-rouge">None</code> group. Now, when the web applications target is executed, the views will not be copied over as they are not <code class="language-plaintext highlighter-rouge">Content</code> type anymore.</p>

<p>That’s all there is to it.</p>

<p>Wait, what about using the <code class="language-plaintext highlighter-rouge">RazorGenerator</code> Visual Studio extension which generates the backing <code class="language-plaintext highlighter-rouge">.generated.cs</code> file when you save the file. I decided not to go with that approach because using the msbuild targets is much cleaner. With the extension approach, not only do you need an extension to visual studio that every team member has to be told to install, all view files, old and new, have to be edited to specify a custom tool. Also, the <code class="language-plaintext highlighter-rouge">.generated.cs</code> files pollute you solution while navigating. Too much of an hassle, and I don’t recommend that approach. Using the steps given above, you can achieve precompilation of your razor views without any changes to the way you have been developing so far.</p>

  </div>
  
    <div class="divider">Comments</div>
    <section>
      <div id="disqus_thread" aria-live="polite">
<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/blog/2013/01/19/precompiling-razor-views-in-asp-dot-net-mvc-3/';
      this.page.identifier = 'http://localhost:4000/blog/2013/01/19/precompiling-razor-views-in-asp-dot-net-mvc-3/';
    };
    
    (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://stacktoheap.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
  
</article>

    </div>

    <footer class="footer footer-center p-10 bg-base-200 text-base-content rounded">
  <div class="grid grid-flow-col gap-4">
  </div> 
  <div>
    <div class="grid grid-flow-col gap-4">
      <a href="https://github.com/manojlds"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path></svg></a> 
      <a href="https://github.com/manojlds"><svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="inline-block h-5 w-5 fill-current md:h-6 md:w-6"><path d="M256,32C132.3,32,32,134.9,32,261.7c0,101.5,64.2,187.5,153.2,217.9a17.56,17.56,0,0,0,3.8.4c8.3,0,11.5-6.1,11.5-11.4,0-5.5-.2-19.9-.3-39.1a102.4,102.4,0,0,1-22.6,2.7c-43.1,0-52.9-33.5-52.9-33.5-10.2-26.5-24.9-33.6-24.9-33.6-19.5-13.7-.1-14.1,1.4-14.1h.1c22.5,2,34.3,23.8,34.3,23.8,11.2,19.6,26.2,25.1,39.6,25.1a63,63,0,0,0,25.6-6c2-14.8,7.8-24.9,14.2-30.7-49.7-5.8-102-25.5-102-113.5,0-25.1,8.7-45.6,23-61.6-2.3-5.8-10-29.2,2.2-60.8a18.64,18.64,0,0,1,5-.5c8.1,0,26.4,3.1,56.6,24.1a208.21,208.21,0,0,1,112.2,0c30.2-21,48.5-24.1,56.6-24.1a18.64,18.64,0,0,1,5,.5c12.2,31.6,4.5,55,2.2,60.8,14.3,16.1,23,36.6,23,61.6,0,88.2-52.4,107.6-102.3,113.3,8,7.1,15.2,21.1,15.2,42.5,0,30.7-.3,55.5-.3,63,0,5.4,3.1,11.5,11.4,11.5a19.35,19.35,0,0,0,4-.4C415.9,449.2,480,363.1,480,261.7,480,134.9,379.7,32,256,32Z"></path></svg></a> 
    </div>
  </div> 
  <div>
    <p>Copyright © 2023 - StackToHeap</p>
  </div>
</footer>

    <script type="text/javascript">
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

  </body>

</html>
